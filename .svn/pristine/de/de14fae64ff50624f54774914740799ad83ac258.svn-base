var util = require('../../lib/util'),
    login = require('../index');


Page({
    data : {
        code : "",//区号
        codeDes : "",//区号对应的中文
        telephone : "",
        
        defaultSelectCountry : 0,
        
        countryCodeList : [
        /*
            [86,"中国"],
            [1,"美国"],
        */
        ]
    },

    showError : function(obj){
        util.showModal({
            title: obj.title || "",
            content: obj.str
        })
    },

    teleSubmit : function(){
        var _this = this;
        
        if(!_this.data.code || !_this.data.telephone){
            _this.showError({ str : "请正确填写区号及手机号" });
            return;
        }

        util.request({
            showMask: true,
            url : login.config.bindCheckApi+"?phone="+ _this.data.telephone +"&countryCode="+ _this.data.code,
            succOption : {
                success : function(data){

                    var r = data.result,
                        status = Number(r.wechatRegisted);
                    /*
                     首先 到这里 就说明 上游的微信 已经是没有绑定过手机的
                     判断当前手机号是否绑定了其它微信
                     未绑定
                     提示 发送验证码
                     绑定了
                     提示 请更换手机号
                     */
                    if(status === 0){//发送验证码
                        util.showModal({
                            title: '确认手机号码',
                            content: "我们将发送验证码短信到这个号码,+"+ _this.data.code +" "+ _this.data.telephone,
                            showCancel: true,
                            confirmText: '确认',
                            success: function(res) {
                                if (res.confirm) {
                                    wx.navigateTo({
                                        url: "./verifyCode?country_code="+ _this.data.code +"&telephone="+ _this.data.telephone +"&_t="+ Date.now()
                                    })
                                }
                            }
                        })
                    }
                    else if(status === 1){//请更换手机号
                        util.showModal({
                            title: '',
                            content: "该手机号已绑定其他微信,请更换手机号",
                            confirmText: '确认'
                        })
                    }
                    else{
                        _this.showError({ str : "绑定状态查询失败，请重试" });
                    }
                }
            },
            fail : function(){
                _this.showError({ str : "获取手机号状态出错，请重试" });
            }
        });
    },
    
    teleInput : function(e){
        this.setData({
            telephone : e.detail.value
        });
    },

    changeCountry : function(e){//国家选择
        var d = this.data.countryCodeList[e.detail.value];//全局数组里的[第几项]
        this.setData({
            code : d[0],
            codeDes : d[1]
        });
    },
    
    getCountryList : function(){
        var _this = this;
        util.request({
            url : login.config.countryCodesApi,
            succOption : {
                success : function(data){

                    var r = data.result,
                        l = r.length,
                        arr = [],
                        default_select = 0;

                    for(var i = 0; i < l; i++){
                        var d = r[i];
                        if(Number(d.c) === 86){
                            default_select = i;
                        }
                        arr.push([d.c,d.n]);
                    }

                    _this.setData({
                        defaultSelectCountry : default_select,
                        code : arr[default_select][0],
                        codeDes : arr[default_select][1],
                        countryCodeList : arr
                    });
                }
            },
            fail : function(){
                _this.showError({ str : "获取国家区号出错，请重试" });
            }
        });
    },

    onShow : function(){
        this.getCountryList();
    },
    
    onLoad: function () {
    }
});