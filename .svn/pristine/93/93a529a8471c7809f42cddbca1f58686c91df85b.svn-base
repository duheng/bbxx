var util = require('../../lib/util'),
    login = require('../index');

Page({
    data : {
        code : "",
        telephone : "",
        identifyingCode : "",//用户输入的验证码
        
        regetCodeText : "重发",//重发 60S
        canRegetCode : true,

        codeSubmitLoading : false
    },
    
    showError : function(obj){
        util.showModal({
            title: obj.title || "提示",
            content: obj.str
        })

    },

    codeSubmit : function(){
        var _this = this;
        
        _this.setData({
            codeSubmitLoading : true
        });

        util.request({
            url : login.config.vcodeCheckApi+"?phone="+ _this.data.telephone +"&countryCode="+ _this.data.code +"&vcode="+ _this.data.identifyingCode +"&session="+ encodeURIComponent(wx.getStorageSync("login_no_bind_tele_session")),
            data : {
                action : login.config.bindApi,
            },
            succOption : {
                success : function(data){

                    console.log("验证码验证成功 继续请求绑定");
                    var session = data.result;

                    util.request({
                        url : login.config.bindApi+"?clientType="+ login.curSystem +"&phone="+ _this.data.telephone +"&countryCode="+ _this.data.code +"&session="+ encodeURIComponent(session),
                        complete : function(){
                            _this.setData({
                                codeSubmitLoading : false
                            });
                        },
                        succOption : {
                            success : function(data){

                                console.log("绑定成功");

                                wx.setStorageSync("login_no_bind_tele_session","");//绑定成功后 删除！

                                //取信息 走人
                                var r = data.result;
                                login.setLoginInfo(r);

                                //显示成功层 然后跳转
                                wx.showToast({
                                    title: '绑定手机号成功',
                                    icon: 'loading',
                                    duration: 10000,
                                    complete:function(){
                                        wx.navigateBack({delta:6});//到回首页
                                    }
                                });
                            }
                        },
                        fail : function(){
                            _this.showError({ str : "绑定手机号出错，请重试" });
                        }
                    });
                },
                error : function(data){
                    _this.setData({
                        codeSubmitLoading : false
                    });
                    _this.showError({ str : data.status.status_reason });
                }
            },
            fail : function(){
                _this.setData({
                    codeSubmitLoading : false
                });
                _this.showError({ str : "检测验证码出错，请重试" });
            }
        });
    },

    codeInput : function(e){
        this.setData({
            identifyingCode : e.detail.value
        });
    },

    noneGetCode : function(){
        var _this = this;

        util.request({
            url : login.config.mediaVcodeApi + "?riskSwitch=false&phone="+ _this.data.telephone +"&countryCode="+ _this.data.code,
            succOption : {
                success : function(data){

                    _this.showError({
                        title : "获取语音验证码成功",
                        str : "验证码将以电话形式通知到你，请注意接听"
                    });
                }
            },
            fail : function(){
                _this.showError({ str : "获取语音验证码错误，请重试" });
            }
        });
    },
    
    regetCode : function(){
        if(this.data.canRegetCode){
            this.getCode();
        }
    },
    
    calcRegetCodeTime : function(){
        var _this = this,
            time = 60;
        
        _this.setData({
            regetCodeText : "60S",
            canRegetCode : false
        });
        
        var timeGO = setInterval(function(){
            if(time === 1){
                _this.setData({
                    canRegetCode : true,
                    regetCodeText : "重发"
                });
                clearInterval(timeGO);
            }
            else{
                time--;
                _this.setData({
                    regetCodeText : time +"S"
                });
            }
        },1000);
    },
    
    getCode : function(){
        var _this = this;

        util.request({
            url : login.config.msgVcodeApi + "?riskSwitch=false&phone="+ _this.data.telephone +"&countryCode="+ _this.data.code,
            succOption : {
                success : function(data){

                    _this.calcRegetCodeTime();
                }
            },
            fail : function(){
                _this.showError({ str : "获取验证码出错，请重试" });
            }
        });
    },
    
    onLoad: function (e) {
        this.setData({
            code : e.country_code,
            telephone : e.telephone
        });
        
        this.getCode();
    }
});